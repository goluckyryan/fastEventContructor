#!/bin/bash -l

expName="TAC2"
timeWin=1000

# Ensure a run number is provided
if [ -z "$1" ]; then
    echo "Usage: $0 <run_number> [BUILD] [ANALYSIS]"
    exit 1
fi

RUN=$(printf "%03d" "$1")

# Check for --BUILD argument
BUILD=1
if [ -n "$2" ]; then
    BUILD=$2
fi

ANALYSIS=1
if [ -n "$3" ]; then
    ANALYSIS=$3
fi

echo "################ Process Run-${RUN}"

dataPattern="data/${expName}_${RUN}/${expName}_${RUN}*"
outFileName="root_data/${expName}_${RUN}.root"

inputFiles=$(ls -1 ${dataPattern} 2>/dev/null)

if [ -z "$inputFiles" ]; then
    echo "No data files found for pattern: ${dataPattern}"
    exit 1
fi

if [ $BUILD -eq 0 ]; then
    echo "skipp event building"
else
    if [ $BUILD -lt 1 ] || [ ! -f "${outFileName}" ] || find ${dataPattern} -newer "${outFileName}" | grep -q .; then
        echo "Running EventBuilder to generate: ${outFileName}"
        ./EventBuilder "${outFileName}" "${timeWin}" ${inputFiles}
    else
        echo "Skipping EventBuilder; ${outFileName} is up to date."
    fi
fi

echo "################################"

if [ $ANALYSIS -ge 1 ]; then
    echo "Running analyzer on: ${outFileName}"
    root 'analyzer.cpp("'${outFileName}'")'
else
    echo "Skipping analysis step."
fi  
